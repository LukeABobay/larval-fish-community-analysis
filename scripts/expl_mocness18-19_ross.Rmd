---
title: "mocness18-19explore"
output: word_document
date: "2025-07-30"
knit: (function(input, encoding) {

  rmarkdown::render(

    input,

    output_dir = here::here("output"),

    output_file = paste0(xfun::sans_ext(input), '_', Sys.Date(), '.html')

    )

  })
  ---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(here)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
```

```{r Define variables}
# Categories of species with >15 individuals from MEZCAL
coastal_species <- c("Apodichthus flavidus", "Artedius spp.", "Citharichthys spp.", "Cottidae", "Isopsetta isolepis", "Liparis fucensis", "Ophiodon elongatus", "Parophrys vetulus", "Psettichthys melanostictus", "Sebastes spp.", "Xiphister atrophurpureus")
coastal_colors <- colorRampPalette(brewer.pal(9, "Greens")[2:9])(length(coastal_species))

coastal_oceanic_species <- c("Engraulis mordax", "Glyptocephalus zachirus", "Lestidiops ringens", "Lyopsetta exilis")
coastal_oceanic_colors <- colorRampPalette(brewer.pal(9, "Blues")[2:9])(length(coastal_oceanic_species))

oceanic_species <- c("Chauliodus macouni", "Diaphus theta", "Lipolagus ochotensis", "Myctophidae", "Protomyctophum crockeri", "Stenobrachius leucopsarus", "Tarletonbeania crenularis")
oceanic_colors <- colorRampPalette(brewer.pal(9, "Purples")[2:9])(length(oceanic_species))

# Named species color vector
species_colors <- c(setNames(coastal_colors, coastal_species),
                    setNames(coastal_oceanic_colors, coastal_oceanic_species),
                    setNames(oceanic_colors, oceanic_species))

# Vector of taxa ordered alphabetically within categories to order bars and figure legends
ordered_taxa <- c(coastal_species, coastal_oceanic_species, oceanic_species)

```

```{r}
source(here("scripts/01_data_wrangling.R"))
```

```{r Add columns with combined location/station and min/max depth}
mocness_18_19_merge_station <- unite(mocness_2018_2019, col = "location_station", location, station, sep="_", remove = TRUE)

mocness_18_19_depth_range <- unite(mocness_18_19_merge_station, col = "depth_range", minimum_depth_m, maximum_depth_m, sep="-", remove = TRUE)
```

```{r Reduce number of larval fish taxa}
taxa_w_gt_15 <- mocness_18_19_depth_range %>%
  group_by(taxon) %>%
  summarize(n = sum(individuals_in_tow, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(n >= 15)

mocness_18_19_major_taxa <- mocness_18_19_depth_range %>%
  filter(taxon %in% taxa_w_gt_15$taxon & taxon != "Unknown" & !is.na(taxon) & taxon != "Damaged") %>%
  mutate(taxon = case_match(taxon, 
                            c("Citharichthys sordidus", "Citharichthys stigmaeus") ~ "Citharichthys spp.",
                            "Artedius harringtoni" ~ "Artedius spp.",
                            .default = taxon)) %>%
  # Reorder taxa
  mutate(taxon = factor(taxon, levels = ordered_taxa)) %>%
  mutate(adult_habitat_affinity = case_when(taxon %in% coastal_species ~ "Coastal",
                                            taxon %in% coastal_oceanic_species ~ "Coastal-oceanic",
                                            taxon %in% oceanic_species ~ "Oceanic",
                                            TRUE ~ "Other"))
```

```{r Plot taxon counts by station and depth}
ggplot(mocness_18_19_depth_range, aes(x = taxon, y = individuals_in_tow)) +
  geom_bar(stat = "identity") +
  facet_grid(depth_range ~ location_station) +
  labs(title = "Taxon Counts by Station and Depth Range",
       x = "Taxon Group", y = "Count") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave("plot_mocness_18_19_counts_station_depth.tif", plot = last_plot(), device = "tiff", path=here("output"), width = 36, height = 6, units = "in", dpi = 300)

ggplot(mocness_18_19_depth_range, aes(x = taxon, y = log(individuals_in_tow))) +
  geom_bar(stat = "identity") +
  facet_grid(depth_range ~ location_station) +
  labs(title = "Taxon Counts by Station and Depth Range",
       x = "Taxon Group", y = "log(Count)") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave("plot_mocness_18_19_log_counts_station_depth.tif", plot = last_plot(), device = "tiff", path=here("output"), width = 36, height = 6, units = "in", dpi = 300)
```

```{r Stacked barplots of major taxa}
ggplot(mocness_18_19_major_taxa, aes(x = depth_range, y = individuals_in_tow, fill = taxon)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = species_colors) +
  facet_grid(~ location_station) +
  labs(title = "Taxon Counts by Station and Depth Range",
       x = "Taxon Group", y = "Count") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave("plot_mocness_18_19_stacked_station_depth.tif", plot = last_plot(), device = "tiff", path=here("output"), width = 15, height = 6, units = "in", dpi = 300)

ggplot(mocness_18_19_major_taxa, aes(x = depth_range, y = log(individuals_in_tow), fill = taxon)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = species_colors) +
  facet_grid(~ location_station) +
  labs(title = "Taxon Counts by Station and Depth Range",
       x = "Taxon Group", y = "log(Count)") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave("plot_mocness_18_19_log_stacked_station_depth.tif", plot = last_plot(), device = "tiff", path=here("output"), width = 15, height = 6, units = "in", dpi = 300)

ggplot(mocness_18_19_major_taxa, aes(x = depth_range, y = log(individuals_in_tow), fill = taxon)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = species_colors) +
  facet_grid(date ~ location_station) +
  labs(title = "Taxon Counts by Station and Depth Range",
       x = "Taxon Group", y = "log(Count)") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave("plot_mocness_18_19_stacked_station_depth_date.tif", plot = last_plot(), device = "tiff", path=here("output"), width = 15, height = 15, units = "in", dpi = 300)
```

